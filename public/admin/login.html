<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CME Admin â€” Sign In</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --navy900: #0D1321; --navy800: #131B2E; --navy700: #1D2A3F; --navy600: #2A3A52;
    --sand500: #A68B5B; --sand400: #D4C4B0; --sand50: #FDFCFB;
    --green: #5B8C6B; --red: #B85C5C;
    --amberMuted: #8B7349;
    --whiteA60: rgba(255,255,255,0.6); --whiteA15: rgba(255,255,255,0.15);
    --whiteA08: rgba(255,255,255,0.08); --whiteA04: rgba(255,255,255,0.04);
  }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', sans-serif;
    background: var(--navy900); color: var(--sand50);
    min-height: 100vh; display: flex; align-items: center; justify-content: center;
  }
  .login-container {
    width: 100%; max-width: 420px; padding: 24px;
  }
  .brand { text-align: center; margin-bottom: 40px; }
  .brand-icon {
    width: 56px; height: 56px; border-radius: 14px;
    background: linear-gradient(135deg, var(--sand500), var(--amberMuted));
    display: inline-flex; align-items: center; justify-content: center;
    font-size: 22px; font-weight: 700; color: #fff; margin-bottom: 16px;
  }
  .brand-title { font-size: 22px; font-weight: 500; letter-spacing: -0.5px; color: var(--sand50); }
  .brand-sub { font-size: 13px; color: var(--sand400); margin-top: 4px; letter-spacing: 0.5px; }

  .card {
    background: var(--navy800); border: 1px solid var(--whiteA08);
    border-radius: 16px; padding: 32px; margin-bottom: 16px;
  }
  .card-title { font-size: 16px; font-weight: 500; margin-bottom: 4px; }
  .card-sub { font-size: 13px; color: var(--sand400); margin-bottom: 24px; }

  .form-group { margin-bottom: 16px; }
  .form-label { display: block; font-size: 11px; color: var(--sand400); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 6px; }
  .form-input {
    width: 100%; padding: 12px 16px; background: var(--whiteA04);
    border: 1px solid var(--whiteA15); border-radius: 10px;
    color: var(--sand50); font-size: 14px; outline: none; font-family: inherit;
    transition: border-color 0.2s;
  }
  .form-input:focus { border-color: var(--sand500); }
  .form-input::placeholder { color: rgba(255,255,255,0.3); }

  .btn-primary {
    width: 100%; padding: 14px; margin-top: 8px;
    background: linear-gradient(135deg, var(--sand500), var(--amberMuted));
    border: none; border-radius: 10px; color: #fff;
    font-size: 14px; font-weight: 500; cursor: pointer;
    font-family: inherit; transition: opacity 0.15s;
  }
  .btn-primary:hover { opacity: 0.9; }
  .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

  .error-msg {
    background: rgba(184,92,92,0.12); border: 1px solid rgba(184,92,92,0.3);
    border-radius: 8px; padding: 10px 14px; margin-bottom: 16px;
    font-size: 13px; color: var(--red); display: none;
  }
  .error-msg.show { display: block; }

  .footer-links {
    text-align: center; font-size: 12px; color: var(--sand400);
  }
  .footer-links a { color: var(--sand500); text-decoration: none; }
  .footer-links a:hover { text-decoration: underline; }

  .spinner {
    display: inline-block; width: 16px; height: 16px;
    border: 2px solid rgba(255,255,255,0.3); border-top-color: #fff;
    border-radius: 50%; animation: spin 0.6s linear infinite;
    vertical-align: middle; margin-right: 8px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<div class="login-container">
  <div class="brand">
    <div class="brand-icon">C</div>
    <div class="brand-title">CME Admin</div>
    <div class="brand-sub">Staff Portal</div>
  </div>

  <div class="card">
    <div class="card-title">Sign in</div>
    <div class="card-sub">Access your agency's physician compliance dashboard</div>

    <div class="error-msg" id="errorMsg"></div>

    <form id="loginForm" onsubmit="handleLogin(event)">
      <div class="form-group">
        <label class="form-label">Email Address</label>
        <input class="form-input" id="email" type="email" placeholder="you@agency.com" required autocomplete="email">
      </div>
      <div class="form-group">
        <label class="form-label">Password</label>
        <input class="form-input" id="password" type="password" placeholder="Enter your password" required autocomplete="current-password">
      </div>
      <button class="btn-primary" id="submitBtn" type="submit">Sign In</button>
    </form>
  </div>

  <div class="footer-links">
    <a href="/">Back to CME Agent</a>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = 'https://drwpnasiqgzqdubmlwxj.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRyd3BuYXNpcWd6cWR1Ym1sd3hqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyMzE5MzAsImV4cCI6MjA4NTgwNzkzMH0.26RVUHuFDcYfMBLTsodSP9jUE01qYRn9bfQ-nfqtt7Y';

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// If already logged in as staff/admin, redirect
(async () => {
  const { data: { session } } = await sb.auth.getSession();
  if (session) {
    const { data: profile } = await sb.from('profiles').select('role').eq('id', session.user.id).single();
    if (profile && (profile.role === 'staff' || profile.role === 'admin')) {
      window.location.href = '/admin/';
    }
  }
})();

async function handleLogin(e) {
  e.preventDefault();
  const btn = document.getElementById('submitBtn');
  const errEl = document.getElementById('errorMsg');
  const email = document.getElementById('email').value.trim().toLowerCase();
  const password = document.getElementById('password').value;

  errEl.classList.remove('show');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span>Signing in...';

  try {
    const { data, error } = await sb.auth.signInWithPassword({ email, password });
    if (error) throw error;

    // Check role
    const { data: profile, error: pErr } = await sb.from('profiles').select('role, agency_id').eq('id', data.user.id).single();
    if (pErr) throw new Error('Could not load profile');

    if (!profile.role || profile.role === 'physician') {
      await sb.auth.signOut();
      throw new Error('This portal is for agency staff only. Physicians should use the CME Agent app.');
    }

    if (!profile.agency_id) {
      await sb.auth.signOut();
      throw new Error('Your account is not associated with an agency. Contact your administrator.');
    }

    window.location.href = '/admin/';
  } catch (err) {
    errEl.textContent = err.message || 'Sign in failed. Please try again.';
    errEl.classList.add('show');
    btn.disabled = false;
    btn.textContent = 'Sign In';
  }
}
</script>
</body>
</html>
